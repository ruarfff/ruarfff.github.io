{"componentChunkName":"component---src-templates-blog-post-js","path":"/understanding-python-async/","result":{"data":{"site":{"siteMetadata":{"title":"Ruairí's Blog"}},"markdownRemark":{"id":"a762a3c1-1ddb-5d98-ad4d-5305fce7a25b","excerpt":"Writing asynchronous code in python is quite powerful and can perform pretty well if you use something like uvloop: uvloop makes asyncio fast. In fact, it is at…","html":"<p>Writing asynchronous code in python is quite powerful and can perform pretty well if you use something like <a href=\"https://uvloop.readthedocs.io/\">uvloop</a>:</p>\n<blockquote>\n<p>uvloop makes asyncio fast. In fact, it is at least 2x faster than nodejs, gevent, as well as any other Python asynchronous framework. The performance of uvloop-based asyncio is close to that of Go programs.</p>\n</blockquote>\n<p>Writing asynchronous code in python is also pretty easy to mess up.</p>\n<p>This post is an attempt to understand async python a little better and make it easier to spot the common mistakes.</p>\n<p>There’s a repo if you’d like to have the code examples: <a href=\"https://github.com/ruarfff/understanding-python-async\">https://github.com/ruarfff/understanding-python-async</a></p>\n<p>In this post we will look at:</p>\n<ul>\n<li>async/concurrent vs parallel</li>\n<li>interesting things to know about async in python</li>\n<li>async with FastAPI</li>\n<li>what do do if something you use doesn’t support async</li>\n</ul>\n<h2>Coding along</h2>\n<p>Make sure to have python >= 3.8 installed.</p>\n<p>You should be using a unix like shell e.g. Linux, Mac, WSL.</p>\n<p>My setup (you don’t need to use this exact version):</p>\n<ul>\n<li><a href=\"https://github.com/pyenv/pyenv\">pyenv</a></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pyenv install 3.10.6\n\npyenv global 3.10.6</code></pre></div>\n<ul>\n<li><code class=\"language-text\">git clone git@github.com:zoe/understanding-python-async.git &amp;&amp; cd understanding-python-async</code></li>\n<li>Setup a <a href=\"https://docs.python.org/3/library/venv.html\">virtual environment</a> and run all commands in this context</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">python -m venv ./.venv\n\nsource .venv/bin/activate</code></pre></div>\n<ul>\n<li>Install requirements <code class=\"language-text\">pip install -r requirements.txt</code></li>\n<li>You should also have <a href=\"https://curl.se/\">curl</a> installed</li>\n</ul>\n<h2>Async Vs Parallel</h2>\n<p>Parallel and asynchronous are not the same thing. If you have a good mental model for async vs parallel feel free to skip this section.</p>\n<p>When I was in college I wrote a mobile game. I had to learn about <a href=\"https://gameprogrammingpatterns.com/game-loop.html\">the game loop</a>.</p>\n<p>Within the loop, I had code to:</p>\n<ul>\n<li>process inputs</li>\n<li>update the game state based on reactions to inputs and existing algorithms</li>\n<li>render the game</li>\n</ul>\n<p>It was all perfectly synchronous so I couldn’t have anything take too long or the game would become unplayable. I became obsessed with improving performance but I always hit limits. I was attempting to render at 30FPS (frames per second meaning the loop must carry out all processing at least 30 times per second). Every time I coded up a new game agent or increased the number of agents on the screen, the FPS would suffer and I’d go mad trying to figure out how to optimise performance again. Then one day, I discovered the joy and pain of async programming.</p>\n<p>Mobile games ran on a single processor but using threading, you could simulate parallelism. It was, in fact, asynchronous but you didn’t really have to think too hard about scheduling the threads. You hand that job over to the operating system. It did make things a lot more complicated and harder to understand though and that’s the major tradeoff.</p>\n<p>This might be fairly inaccurate but I like to think of asyncio (and its Cython-based friend uvloop) as a sort of game loop. It’s not running in parallel but the loop will keep looping if you don’t block it. If you do block it, you mess the whole thing up.</p>\n<p>Where that mental model breaks down is when we think about CPU bound VS IO-bound.</p>\n<p>Asynchronous code makes sense when there’s a lot of waiting or the code is IO-Bound. It’s somewhat more intuitive. Like when you are coding. Consider an example flow:</p>\n<h4>Task - get some code to production</h4>\n<ul>\n<li>you write some code</li>\n<li>run and test the code</li>\n<li>commit and push the code</li>\n<li>watch the build pipeline</li>\n<li>get distracted and start chatting on slack/teams</li>\n<li>go for lunch</li>\n<li>remember you had a build pipeline running</li>\n<li>test the deployment</li>\n<li>done</li>\n</ul>\n<p>There are steps you don’t wait for e.g. watching the build pipeline. This is asynchronous and frees you up to do other things. It’s not necessarily more efficient but it’s better than sitting there waiting for the build pipeline to finish. You got other tasks done while also getting the code to production.</p>\n<p>A build pipeline has steps that can be run in <strong>parallel</strong> e.g. testing and linting. This can be done in parallel if we give each step all its own resources and a dedicated machine. We could do all the steps <strong>asynchronously</strong> on one large machine but we can use many smaller, cheaper machines to do the work in parallel.</p>\n<p>You can think of async as one resource doing many things at once and figuring out how not to wait for each thing to be finished. Parallel processing is multiple resources each working on separate tasks or parts of a task.</p>\n<p>Throughout the rest of this post, we will be focusing on the asynchronous model. When writing python apps with a framework like FastAPI, we are generally doing IO-Bound work e.g. downstream requests, reading databases, files etc. The asynchronous model is most useful in this case.</p>\n<p>We will focus primarily on the patterns for using <a href=\"https://docs.python.org/3/library/asyncio-task.html\">coroutines</a> and async/await.</p>\n<h2>Example of async code using asyncio</h2>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> asyncio\n<span class=\"token keyword\">import</span> datetime\n<span class=\"token keyword\">import</span> time\n\n<span class=\"token keyword\">from</span> colorama <span class=\"token keyword\">import</span> init\n<span class=\"token keyword\">from</span> colorama <span class=\"token keyword\">import</span> Fore<span class=\"token punctuation\">,</span> Back<span class=\"token punctuation\">,</span> Style\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>Back<span class=\"token punctuation\">.</span>GREEN <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE <span class=\"token operator\">+</span> <span class=\"token string\">\"Starting synchronous work.\"</span><span class=\"token punctuation\">,</span> flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n\n    start_time <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    synchronous_work<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    synchronous_work<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    end_time <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start_time\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>\n        Back<span class=\"token punctuation\">.</span>GREEN\n        <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE\n        <span class=\"token operator\">+</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"Ending synchronous work. Total time: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>end_time<span class=\"token punctuation\">.</span>total_seconds<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><span class=\"token format-spec\"> .2</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> sec.\"</span></span><span class=\"token punctuation\">,</span>\n        flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>Back<span class=\"token punctuation\">.</span>MAGENTA <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE <span class=\"token operator\">+</span> <span class=\"token string\">\"Starting awaiting async functions.\"</span><span class=\"token punctuation\">,</span> flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n\n    start_time <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">await</span> async_work<span class=\"token punctuation\">(</span>Back<span class=\"token punctuation\">.</span>LIGHTYELLOW_EX <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">await</span> async_work<span class=\"token punctuation\">(</span>Back<span class=\"token punctuation\">.</span>LIGHTRED_EX <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE<span class=\"token punctuation\">)</span>\n\n    end_time <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start_time\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>\n        Back<span class=\"token punctuation\">.</span>MAGENTA\n        <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE\n        <span class=\"token operator\">+</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"Ending awaiting async functions. Total time: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>end_time<span class=\"token punctuation\">.</span>total_seconds<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><span class=\"token format-spec\"> .2</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> sec.\"</span></span><span class=\"token punctuation\">,</span>\n        flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>Back<span class=\"token punctuation\">.</span>LIGHTBLUE_EX <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE <span class=\"token operator\">+</span> <span class=\"token string\">\"Starting running async.\"</span><span class=\"token punctuation\">,</span> flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n\n    start_time <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    tasks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        async_work<span class=\"token punctuation\">(</span>Back<span class=\"token punctuation\">.</span>LIGHTYELLOW_EX <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        async_work<span class=\"token punctuation\">(</span>Back<span class=\"token punctuation\">.</span>LIGHTRED_EX <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">await</span> asyncio<span class=\"token punctuation\">.</span>gather<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>tasks<span class=\"token punctuation\">)</span>\n\n    end_time <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start_time\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>\n        Back<span class=\"token punctuation\">.</span>LIGHTBLUE_EX\n        <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE\n        <span class=\"token operator\">+</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"Ending running async. Total time: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>end_time<span class=\"token punctuation\">.</span>total_seconds<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><span class=\"token format-spec\"> .2</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> sec.\"</span></span><span class=\"token punctuation\">,</span>\n        flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>Style<span class=\"token punctuation\">.</span>RESET_ALL<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">synchronous_work</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>Back<span class=\"token punctuation\">.</span>CYAN <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE <span class=\"token operator\">+</span> <span class=\"token string\">\"Pretending to wait.\"</span><span class=\"token punctuation\">)</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">async_work</span><span class=\"token punctuation\">(</span>colour<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span> <span class=\"token operator\">=</span> Fore<span class=\"token punctuation\">.</span>WHITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>colour <span class=\"token operator\">+</span> <span class=\"token string\">\"Pretending to wait async.\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">await</span> asyncio<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    init<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    asyncio<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/461840d2b32c17eb2c4cd62bfd0a3830/58bb7/async1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.734177215189874%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACZklEQVQoz3XIbUyMAQDA8eejMU1H53XpVTmlLzYxxZqvTaZJL3rVnUjXNeqaQi9mlTV03V3XXXfPvUWxtZI4tjab2KzMVJINvY6Q2vjC7O9xDA0ffvtvfyFcu5WIczGEVUSzsWo7kdW7CKkKJaDOB3nSIpb4CywO+inwj/6HENtQx25XM3GikVibgd2ijSgxA3/3elZVBiBLXcPyrLXIsld7+XrJWJa9VOLzF2Gb3sHOtpvEuDqJdl5nh+sGkQ4LQWI1oVdq2NBRQ/i1OqLcDUS5dFIvssVxi2jxMdH2fsnAAsJ+ZRppmhySCzI5qDlEakEWaQVKDuSrSFLlkpJ5mPj8FOTGdcib1rHGtBZ/XSrBF6sJvlROyKVTCwj9Oh2vL19m3OFk0mmXOJlwOJhutdOVYEPc7MQc20RpepFE4602M0+SQ3GGEs3BvAWE7ng1DxPL6Nur5UFCCff3/NAXX0x/vY4Bl5VH5haGm9wMm1oZMroZamxl0NDOWLOVr+5aPrvO88X9g5CedY+8/JfkHh5FdfQ5StUoh469QJ1wn9OrbGj9nGhldkr8RErkdrQrbJT6tkhf5OzKRmyBZ7AEVtISWOElDFyp5U1vMxMeA9MePVO3DUzeMTLbXY/F0MvJhmdUNT6hUjfoVaYf5UTTGMXGVxw3jqPWT1Oon/pFuHBEpKW4B1NRFxZNB+aiTkyFnRgKurC29SPeHcHseYrFM4yld5QHV9v5aCln1lrFnLWSeWuF1N+EcOUIEUWfUKg/sEkzR0ThHIrv1PMoVO9Q5MywMeetZIaw3PfEpT4mbV8PyYmef/oGTw/ixDeuo8AAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Async example\"\n        title=\"Async example\"\n        src=\"/static/461840d2b32c17eb2c4cd62bfd0a3830/f058b/async1.png\"\n        srcset=\"/static/461840d2b32c17eb2c4cd62bfd0a3830/c26ae/async1.png 158w,\n/static/461840d2b32c17eb2c4cd62bfd0a3830/6bdcf/async1.png 315w,\n/static/461840d2b32c17eb2c4cd62bfd0a3830/f058b/async1.png 630w,\n/static/461840d2b32c17eb2c4cd62bfd0a3830/40601/async1.png 945w,\n/static/461840d2b32c17eb2c4cd62bfd0a3830/58bb7/async1.png 985w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>This contrived example shows a simple case where asynchronous code got things done faster than blocking code.</p>\n<p>Running 2 tasks that each take 2 seconds asynchronously allows them to be finished in 2 seconds.</p>\n<p>If you await 2 async functions in sequence, it’s sort of like it was done synchronously so if you really want multiple steps to run asynchronously you can use utilities such as the <code class=\"language-text\">asyncio.gather</code> function in that example.</p>\n<h2>It’s Async all the way down</h2>\n<p>An important note that took me a few mistakes to understand, you must use async all the way down. If you block at any point within an async function, you block everything.</p>\n<p>We will explore this more in the FastAPI section but for now, it’s important to be aware that this:</p>\n<div class=\"gatsby-highlight\" data-language=\"pthon\"><pre class=\"language-pthon\"><code class=\"language-pthon\">async def synchronous_work_in_async_function():\n    time.sleep(2)</code></pre></div>\n<p>Has very different effects to this:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">async_work</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">await</span> asyncio<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>The GIL</h2>\n<p>The <a href=\"https://wiki.python.org/moin/GlobalInterpreterLock\">python GIL</a> (global interpreter lock) can lead to some issues when writing async code. For the most part, you’ll probably never notice if you’re writing IO-bound apps but for CPU bound, it may become an issue.</p>\n<blockquote>\n<p>The GIL prevents race conditions and ensures thread safety.</p>\n</blockquote>\n<p>All threads in python share the same memory space. The GIL helps ensure thread safety for multiple threads interacting with the same variable.</p>\n<p>An example of where this might be important. Python uses a ref count to determine if something should be garbage collected.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> sys\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    a_thing <span class=\"token operator\">=</span> <span class=\"token string\">\"a thing\"</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>sys<span class=\"token punctuation\">.</span>getrefcount<span class=\"token punctuation\">(</span>a_thing<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    another_thing <span class=\"token operator\">=</span> a_thing\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>sys<span class=\"token punctuation\">.</span>getrefcount<span class=\"token punctuation\">(</span>another_thing<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">del</span> a_thing\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>sys<span class=\"token punctuation\">.</span>getrefcount<span class=\"token punctuation\">(</span>another_thing<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/48887812fc0849fb6a53ff3bdcb792fb/e9beb/gil.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.68354430379747%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAYUlEQVQY042PvQoAIQyDnbUFFZdDRO2k7/+AOSgc3HA/HT6aIQ2JK0fBXhu9d9Ra0VrDnBMionqMASJCCEHvHy7nrIKZlSdtDdPAlBK89/r0xtXQEuxijCajefK9gXXWFyd3THOy/BpofgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"GIL Output\"\n        title=\"GIL Output\"\n        src=\"/static/48887812fc0849fb6a53ff3bdcb792fb/f058b/gil.png\"\n        srcset=\"/static/48887812fc0849fb6a53ff3bdcb792fb/c26ae/gil.png 158w,\n/static/48887812fc0849fb6a53ff3bdcb792fb/6bdcf/gil.png 315w,\n/static/48887812fc0849fb6a53ff3bdcb792fb/f058b/gil.png 630w,\n/static/48887812fc0849fb6a53ff3bdcb792fb/e9beb/gil.png 730w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>If multiple threads are updating references, you might get an accidental garbage collection or a memory leak. The lock is there to ensure this doesn’t happen and garbage collection is done safely.</p>\n<p>The downside is this can affect performance.</p>\n<blockquote>\n<p>In hindsight, the GIL is not ideal, since it prevents multithreaded CPython programs from taking full advantage of multiprocessor systems in certain situations.</p>\n</blockquote>\n<p>There are ways around this. Some libraries aren’t effected by the GIL e.g. <a href=\"https://numpy.org/\">Numpy.</a>.</p>\n<p>When writing a web app with FastAPI, using async/await and a library like <a href=\"https://www.uvicorn.org/\">uvicorn</a>, the GIL is less of an issue as we are primarily IO bound.</p>\n<h2>Async FastAPI</h2>\n<p>FastAPI is <a href=\"https://fastapi.tiangolo.com/?h=perfor#performance\">quite fast</a>, unless you make it not fast :)</p>\n<p>How does that happen?</p>\n<p>The <a href=\"https://fastapi.tiangolo.com/async/\">async docs for FastAPI</a> are really good. We won’t repeat much from them here but instead look at some examples.</p>\n<p>A “hello world” FastAPI app looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> fastapi <span class=\"token keyword\">import</span> FastAPI\n\napp <span class=\"token operator\">=</span> FastAPI<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">root</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Hello World\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>When we start up our FastAPI service, it will handle requests asynchronously on the eventloop. One worker should be able to handle many requests in this scenario.</p>\n<p>Let’s see what that looks like. If you have the <a href=\"https://github.com/zoe/understanding-python-async\">examples repo</a> you can run ./test-endpoints.sh to see all these outputs or feel free to follow along step by step here.</p>\n<p>Create a hello world sample like the following:</p>\n<p><code class=\"language-text\">touch src/fastapi_example.py</code></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> fastapi <span class=\"token keyword\">import</span> FastAPI\n<span class=\"token keyword\">import</span> time\n<span class=\"token keyword\">import</span> datetime\n<span class=\"token keyword\">import</span> asyncio\n\n<span class=\"token keyword\">from</span> colorama <span class=\"token keyword\">import</span> init\n<span class=\"token keyword\">from</span> colorama <span class=\"token keyword\">import</span> Fore<span class=\"token punctuation\">,</span> Back<span class=\"token punctuation\">,</span> Style\n\napp <span class=\"token operator\">=</span> FastAPI<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">root</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    start_time <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>\n        Back<span class=\"token punctuation\">.</span>GREEN <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE <span class=\"token operator\">+</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"Hello world started at: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>start_time<span class=\"token punctuation\">}</span></span><span class=\"token string\"> sec.\"</span></span><span class=\"token punctuation\">,</span>\n        flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Hello World\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>We can hit the same endpoint multiple times simultaneously with curl.</p>\n<p>Create a text file like this:</p>\n<p><code class=\"language-text\">touch test_urls.txt</code></p>\n<p>Add this content:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">url = \"http://127.0.0.1:8000/\"\nurl = \"http://127.0.0.1:8000/\"\nurl = \"http://127.0.0.1:8000/\"\nurl = \"http://127.0.0.1:8000/\"</code></pre></div>\n<p>Start your FastAPI app:</p>\n<p><code class=\"language-text\">uvicorn src.fastapi_example:app --reload</code></p>\n<p>In another console, run curl:</p>\n<p><code class=\"language-text\">curl --parallel --parallel-immediate --parallel-max 4 --config test_urls.txt</code></p>\n<p>You should see output similar to the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\"message\":\"Hello World\"}{\"message\":\"Hello World\"}{\"message\":\"Hello World\"}{\"message\":\"Hello World\"}{\"message\":\"So slow\"}{\"message\":\"So slow\"}</code></pre></div>\n<p>In the application logs:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e8eb2dda5c9a4489b601ceb05264d8d8/36c33/async-normal.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.0379746835443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABxklEQVQoz22S227TUBBF/QG5ICCJfc6xz8WXhg/gtX2gVICEVJqipqF17diO00JbQcVF/Pxm2+WBSDwsjXVGWtozHk/99hHVCuZLiPjWIr1zMLdhj72OkN67vpd+jRHfGUQ3Evo+hF9NMDwYYLS/iye+zyAXAUwRIVk7pOsYttRwRF8oZE0Cy96LbYakdohyCVkGmBbPMF4NMD4f7uCJhynEiQ9zRWHpejphUjnolcJencKyN99k/Vt0KaEKgekVhUsKl8MdPPlzBrUU0BVHbiyShsImgmuYsAiRbZmwovAmRbKxCEuOvFHw11OMFhQuKOrrI574wZHPOHInrA3HsrA1hfzWOYUthWsKrzshExYSYS3glxSeUnJKYV8f8cQ3Co8D6MsQSe56bK57wqVEViYwFyHmdYa4sFArAZkHmOUTjD9Rshru4EkmVGcChim6pac1f0ql+4SGCfc2/yRsuoSKVyHhF0z48T8J5S8f6lz0e0taCtsYbqMRtxSWFFJkuc/5Zwq3FFY8sZZns55gdELJBwq7+hdvxsb05QThawV7ZHr0EXf41kAeBEjexYgOKX6fwr2xEK8CBIczPD9+iicPAzLc4Q+OKhr4sTEjcwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Async example output\"\n        title=\"Async example output\"\n        src=\"/static/e8eb2dda5c9a4489b601ceb05264d8d8/f058b/async-normal.png\"\n        srcset=\"/static/e8eb2dda5c9a4489b601ceb05264d8d8/c26ae/async-normal.png 158w,\n/static/e8eb2dda5c9a4489b601ceb05264d8d8/6bdcf/async-normal.png 315w,\n/static/e8eb2dda5c9a4489b601ceb05264d8d8/f058b/async-normal.png 630w,\n/static/e8eb2dda5c9a4489b601ceb05264d8d8/40601/async-normal.png 945w,\n/static/e8eb2dda5c9a4489b601ceb05264d8d8/36c33/async-normal.png 946w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>That was perhaps too fast to prove anything.</p>\n<p>Update your endpoint with <code class=\"language-text\">await asyncio.sleep(4)</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">root</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    start_time <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>\n        Back<span class=\"token punctuation\">.</span>GREEN <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE <span class=\"token operator\">+</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"Hello world started at: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>start_time<span class=\"token punctuation\">}</span></span><span class=\"token string\"> sec.\"</span></span><span class=\"token punctuation\">,</span>\n        flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">await</span> asyncio<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Hello World\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Run the test again:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ddeb3e6e88a2fa6368dbf4878fd42f22/97bfd/async-normal-waiting.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.50632911392405%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABi0lEQVQoz2WQu47TUBRFjejiazu28St+X79iZwQSxRQ0INFT8BF8CgUZKCARxYgZgUSe/OPixqQgSrG0t86R9tn3avJrhvyeUa0L8lVMfdZilShfUq5T5Dr7p6uM/r7h2Qcb45WO+UZgvr5EG363LA4dz3c93bbixX7BXGm3lWo2MOxa+m0z6onbw0vijY+9Ebgb8wqt/plTH3Pao2qzT2gPJcU+Ru5TuqOkOmSjP9EcCm7+dAS/HOwfBu6DifNgXKA1jyXNN8n8Y0O7rFgsO+Z3Nc0nyXDyy4bFl47hc0en9jd3c4J7F+eoAneq1f4SzXprIArBdDIlnsUEfkCe5YR+iO/546zMyxEv8Jj4E8xbgfVe8e4azUotTFddc1xkJcky9fF9TylLkjRBStV0GOjnPVEaIWod4Qj0Jzr602s0MzUwVKA9tceAKIooioLZbDb6NE2p65pKVviRj0hVoCcQhsI8639oZmQibPVkazoGBEFAHMd4njcShuEYmiQJrucionNDXakQV/wFITP1ulrxh4cAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Async example with ait output\"\n        title=\"Async example with ait output\"\n        src=\"/static/ddeb3e6e88a2fa6368dbf4878fd42f22/f058b/async-normal-waiting.png\"\n        srcset=\"/static/ddeb3e6e88a2fa6368dbf4878fd42f22/c26ae/async-normal-waiting.png 158w,\n/static/ddeb3e6e88a2fa6368dbf4878fd42f22/6bdcf/async-normal-waiting.png 315w,\n/static/ddeb3e6e88a2fa6368dbf4878fd42f22/f058b/async-normal-waiting.png 630w,\n/static/ddeb3e6e88a2fa6368dbf4878fd42f22/40601/async-normal-waiting.png 945w,\n/static/ddeb3e6e88a2fa6368dbf4878fd42f22/97bfd/async-normal-waiting.png 1078w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Despite each call not responding for 4 seconds, they all kicked off at the same time. FastAPI is handling requests asynchronously.</p>\n<p>Now to demonstrate where things can go wrong, let’s add another endpoint:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/slow\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">slow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    start_time <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>\n        Back<span class=\"token punctuation\">.</span>GREEN <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE <span class=\"token operator\">+</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"Slow started at: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>start_time<span class=\"token punctuation\">}</span></span><span class=\"token string\"> sec.\"</span></span><span class=\"token punctuation\">,</span>\n        flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"So slow\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Here’s we’re using the blocking <code class=\"language-text\">time.sleep</code> instead of the non blocking <code class=\"language-text\">asyncio.sleep</code>.</p>\n<p>Update the urls.txt file:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">url = \"http://127.0.0.1:8000/slow\"\nurl = \"http://127.0.0.1:8000/slow\"\nurl = \"http://127.0.0.1:8000/\"\nurl = \"http://127.0.0.1:8000/\"\nurl = \"http://127.0.0.1:8000/\"\nurl = \"http://127.0.0.1:8000/\"</code></pre></div>\n<p>The order is important. We want the slow ones to kick off first.</p>\n<p>Update the curl command to allow 6 concurrent requests:</p>\n<p><code class=\"language-text\">curl --parallel --parallel-immediate --parallel-max 6 --config test_urls.txt</code></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f2d7d2a4b192b76d713040f6ed8e133b/60b8f/sync-oops.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.44303797468354%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABaElEQVQoz3XNwU/TYBzG8V5MIH1bqt3abuvb9u0QQ8CAyCIS1DACbuACM9w4cvKgiMSNWQWEYMINMN5GNPyjX162cGIePvk9efLmeY3tjxX2DubZyV7y5ccCn/XdyV6wq/Pu99t+jk9a6+cirw7LjL53mWh6jDfzAxmHH17zZ3+Z89YSl/srXOh7ly9b/f7W706NrbNJjjoz/GpXOG3PDmS8PZuief2cd1fTbPydpaFvvTvZy+tXM6x2n7Kmrf+rsNwdp51N8S17RiebHshwvj5CVB3ybwrImkLWFaVaglctEdVTksZj5KrCqeZxNh2cEwvn+P8MOxSIBya+5RPlJYkXE+UkwYjfy0+iMVJPYT+0GHaHEEOib3gww5YWwhH4gR6MI+IkJpQlvMBDlRUqVf2uHBIkAbZrYbomwtID4j7DLtoIW5DL5SgUChSLxR7XdYki/UGsx8KQVKXIksT29fugP2ia5r3BG3Hs5QXl+FEzAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Async with bloging example output\"\n        title=\"Async with bloging example output\"\n        src=\"/static/f2d7d2a4b192b76d713040f6ed8e133b/f058b/sync-oops.png\"\n        srcset=\"/static/f2d7d2a4b192b76d713040f6ed8e133b/c26ae/sync-oops.png 158w,\n/static/f2d7d2a4b192b76d713040f6ed8e133b/6bdcf/sync-oops.png 315w,\n/static/f2d7d2a4b192b76d713040f6ed8e133b/f058b/sync-oops.png 630w,\n/static/f2d7d2a4b192b76d713040f6ed8e133b/40601/sync-oops.png 945w,\n/static/f2d7d2a4b192b76d713040f6ed8e133b/60b8f/sync-oops.png 1217w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Oops! We just blocked all requests from being processed.</p>\n<p>The main takeaway from this is, you just can’t mix asynchronous and synchronous functionality in a FastAPI application this way.</p>\n<p>Consider this next example:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sync-slow\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">sync_slow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    start_time <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>\n        Back<span class=\"token punctuation\">.</span>LIGHTRED_EX <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE <span class=\"token operator\">+</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"Sync slow started at: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>start_time<span class=\"token punctuation\">}</span></span><span class=\"token string\"> sec.\"</span></span><span class=\"token punctuation\">,</span>\n        flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"So slow\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Notice, we are not specifying <code class=\"language-text\">async</code> on the function definition.</p>\n<p>Update our test URLs:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">url = \"http://127.0.0.1:8000/sync-slow\"\nurl = \"http://127.0.0.1:8000/sync-slow\"\nurl = \"http://127.0.0.1:8000/\"\nurl = \"http://127.0.0.1:8000/\"\nurl = \"http://127.0.0.1:8000/\"\nurl = \"http://127.0.0.1:8000/\"</code></pre></div>\n<p>If you don’t specify your endpoint as being async i.e. as <a href=\"https://docs.python.org/3/library/asyncio-task.html\">a coroutine</a>, FastAPI will look after it for you instead as it will assume this route contains blocking calls whereas if you specify <code class=\"language-text\">async</code>, it’s up to you to make sure it really is asynchronous.</p>\n<p>Rules of thumb:</p>\n<ul>\n<li>if all your code uses coroutines i.e. all use async/await, use async when defining your route</li>\n<li>if any of your code is blocking e.g. using requests, some non aio ORM etc. do not use async when specifying the route</li>\n</ul>\n<p>If you use <a href=\"https://docs.python-requests.org/en/latest/\">requests</a> or standard <a href=\"https://www.sqlalchemy.org/\">SQLAlchemy</a> anywhere in a route, you will block the execution.</p>\n<p>Consider alternatives like:</p>\n<ul>\n<li><a href=\"https://docs.aiohttp.org/en/stable/\">https://docs.aiohttp.org/en/stable/</a></li>\n<li><a href=\"https://docs.sqlalchemy.org/en/14/orm/extensions/asyncio.html\">https://docs.sqlalchemy.org/en/14/orm/extensions/asyncio.html</a></li>\n</ul>\n<h2>Pubsub</h2>\n<p>FastAPI is great at managing async within the context of the framework e.g. in a route. It cannot account for any code you write that may be running on some schedule or handling incoming events. Especially if you’re using the same event loop.</p>\n<p>To illustrate, let’s add some pubsub:</p>\n<p><code class=\"language-text\">pip install --upgrade google-cloud-pubsub</code></p>\n<p>This example is pretty contrived and GCP specific but does demonstrate a common mistake.</p>\n<p>If you’d like to follow along please <a href=\"https://cloud.google.com/sdk/docs/install\">install the gcloud cli</a> and run the following to start a pubsub emulator:</p>\n<p><code class=\"language-text\">gcloud beta emulators pubsub start --project=example-project</code></p>\n<p>We are doing this so we can see what happens when our FastAPI application listens to messages out side of standard web requests.</p>\n<p>Update our FastAPI app to handle messages:</p>\n<p>Import the pubsub lib:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> google<span class=\"token punctuation\">.</span>cloud <span class=\"token keyword\">import</span> pubsub_v1</code></pre></div>\n<p>Setup a subscription:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">create_standard_subscription</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n    project_id <span class=\"token operator\">=</span> <span class=\"token string\">\"example-project\"</span>\n    topic_id <span class=\"token operator\">=</span> <span class=\"token string\">\"testing\"</span>\n    subscription_id <span class=\"token operator\">=</span> <span class=\"token string\">\"testing-subscription\"</span>\n\n    publisher <span class=\"token operator\">=</span> pubsub_v1<span class=\"token punctuation\">.</span>PublisherClient<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    subscriber <span class=\"token operator\">=</span> pubsub_v1<span class=\"token punctuation\">.</span>SubscriberClient<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    subscription_path <span class=\"token operator\">=</span> subscriber<span class=\"token punctuation\">.</span>subscription_path<span class=\"token punctuation\">(</span>project_id<span class=\"token punctuation\">,</span> subscription_id<span class=\"token punctuation\">)</span>\n    topic_path <span class=\"token operator\">=</span> publisher<span class=\"token punctuation\">.</span>topic_path<span class=\"token punctuation\">(</span>project_id<span class=\"token punctuation\">,</span> topic_id<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        subscriber<span class=\"token punctuation\">.</span>create_subscription<span class=\"token punctuation\">(</span>\n            request<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> subscription_path<span class=\"token punctuation\">,</span> <span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">:</span> topic_path<span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">except</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Subscription already exists\"</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">:</span> pubsub_v1<span class=\"token punctuation\">.</span>subscriber<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span>Message<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n        start_time <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> message<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"non-blocking\"</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>\n                Back<span class=\"token punctuation\">.</span>BLUE <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE <span class=\"token operator\">+</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"Starting async message at: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>start_time<span class=\"token punctuation\">}</span></span><span class=\"token string\">.\"</span></span><span class=\"token punctuation\">,</span>\n                flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span>\n            message<span class=\"token punctuation\">.</span>ack<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">elif</span> message<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"blocking\"</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>\n                Back<span class=\"token punctuation\">.</span>LIGHTMAGENTA_EX\n                <span class=\"token operator\">+</span> Fore<span class=\"token punctuation\">.</span>WHITE\n                <span class=\"token operator\">+</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"Starting sync message at: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>start_time<span class=\"token punctuation\">}</span></span><span class=\"token string\">.\"</span></span><span class=\"token punctuation\">,</span>\n                flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span>\n            time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n            message<span class=\"token punctuation\">.</span>ack<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    subscriber<span class=\"token punctuation\">.</span>subscribe<span class=\"token punctuation\">(</span>subscription_path<span class=\"token punctuation\">,</span> callback<span class=\"token operator\">=</span>callback<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Listening for messages on </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>subscription_path<span class=\"token punctuation\">}</span></span><span class=\"token string\">..\\n\"</span></span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>on_event</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"startup\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">startup_event</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    create_standard_subscription<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Configure a pubsub client to send messages e.g.</p>\n<p><code class=\"language-text\">touch src/pubsub_client.py</code></p>\n<p>With the following content:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> google<span class=\"token punctuation\">.</span>cloud <span class=\"token keyword\">import</span> pubsub_v1 <span class=\"token keyword\">as</span> pubsub\n<span class=\"token keyword\">import</span> itertools\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    publisher <span class=\"token operator\">=</span> pubsub<span class=\"token punctuation\">.</span>PublisherClient<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    project_id <span class=\"token operator\">=</span> <span class=\"token string\">\"example-project\"</span>\n    topic_id <span class=\"token operator\">=</span> <span class=\"token string\">\"testing\"</span>\n\n    publisher <span class=\"token operator\">=</span> pubsub<span class=\"token punctuation\">.</span>PublisherClient<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    topic_path <span class=\"token operator\">=</span> publisher<span class=\"token punctuation\">.</span>topic_path<span class=\"token punctuation\">(</span>project_id<span class=\"token punctuation\">,</span> topic_id<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        topic <span class=\"token operator\">=</span> publisher<span class=\"token punctuation\">.</span>create_topic<span class=\"token punctuation\">(</span>request<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> topic_path<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Created topic: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>topic<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">except</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Topic already exists\"</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Run 5 non-blocking\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> itertools<span class=\"token punctuation\">.</span>repeat<span class=\"token punctuation\">(</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        future <span class=\"token operator\">=</span> publisher<span class=\"token punctuation\">.</span>publish<span class=\"token punctuation\">(</span>topic_path<span class=\"token punctuation\">,</span> <span class=\"token string\">b\"non-blocking\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>future<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Run 5 blocking\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> itertools<span class=\"token punctuation\">.</span>repeat<span class=\"token punctuation\">(</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        future <span class=\"token operator\">=</span> publisher<span class=\"token punctuation\">.</span>publish<span class=\"token punctuation\">(</span>topic_path<span class=\"token punctuation\">,</span> <span class=\"token string\">b\"blocking\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>future<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>We are going to send some messages to our app and see how it responds in different scenarios. The client uses environment variables to connect to the emulator. You must load the environment variables like so:</p>\n<p><code class=\"language-text\">$(gcloud beta emulators pubsub env-init)</code></p>\n<p>So at this point you should have:</p>\n<ul>\n<li>a running pubsub emulator</li>\n<li>a sample client with the emulator environment variables ready to go in the shell</li>\n</ul>\n<p>Run the client:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">❯ python src/pubsub_client.py\nTopic already exists\nRun 5 non-blocking\n183\n184\n185\n186\n187\nRun 5 blocking\n188\n189\n190\n191\n192</code></pre></div>\n<p>You should see output int he app console like this:</p>\n<p>All the messages were processed asynchronously. The pubsub is using a callback and the eventloop used by FastAPI is not effected.</p>\n<h2>Useful links</h2>\n<ul>\n<li><a href=\"https://docs.aiohttp.org/en/stable/\">https://docs.aiohttp.org/en/stable/</a></li>\n<li><a href=\"https://docs.sqlalchemy.org/en/14/orm/extensions/asyncio.html\">https://docs.sqlalchemy.org/en/14/orm/extensions/asyncio.html</a></li>\n<li><a href=\"https://github.com/alex-sherman/unsync\">https://github.com/alex-sherman/unsync</a></li>\n<li><a href=\"https://asherman.io/projects/unsync.html\">https://asherman.io/projects/unsync.html</a></li>\n<li><a href=\"https://fastapi.tiangolo.com/async/\">https://fastapi.tiangolo.com/async/</a></li>\n<li><a href=\"https://github.com/mikeckennedy/async-await-jetbrains-webcast\">https://github.com/mikeckennedy/async-await-jetbrains-webcast</a></li>\n<li><a href=\"https://stackoverflow.com/questions/61316540/how-to-get-python-fastapi-async-await-functionality-to-work-properly\">https://stackoverflow.com/questions/61316540/how-to-get-python-fastapi-async-await-functionality-to-work-properly</a></li>\n<li><a href=\"https://asgi.readthedocs.io/en/latest/\">https://asgi.readthedocs.io/en/latest/</a></li>\n<li><a href=\"https://uvloop.readthedocs.io/\">https://uvloop.readthedocs.io/</a></li>\n<li><a href=\"https://www.uvicorn.org/\">https://www.uvicorn.org/</a></li>\n<li><a href=\"https://stackoverflow.com/questions/41063331/how-to-use-asyncio-with-existing-blocking-library\">https://stackoverflow.com/questions/41063331/how-to-use-asyncio-with-existing-blocking-library</a></li>\n</ul>","frontmatter":{"title":"Understanding python async","date":"August 26, 2022","description":"Async python with asyncio"}},"previous":{"fields":{"slug":"/circleci-pr-only/"},"frontmatter":{"title":"How to only run a job on a pull request in CircleCI"}},"next":null},"pageContext":{"id":"a762a3c1-1ddb-5d98-ad4d-5305fce7a25b","previousPostId":"1e3a4a46-6114-5e58-8d87-9b09ef07c0cd","nextPostId":null}},"staticQueryHashes":["2841359383","916993862"]}